# media-proxy-go

## これは何
MisskeyのMediaProxyとして使える、Goで書かれた軽量なMediaProxy

### 依存関係
 - libwebp

#### ビルド依存関係
 - libwebp-dev (RHEL系ならlibwebp-devel)
 - Go (**バージョン1.18以上**)

   
### Tips
#### `PORT`環境変数
`PORT`を指定することでlistenするポートを指定できるようになりました。

#### docker-composeで動かす
Docker Hub に一応ビルド済みイメージを上げています。
```
version: '3'
services:
  app:
    image: docker.io/nexryai/mediaproxy-go:latest
    ports:
      - 127.0.0.1:9090:8080
    restart: always
    # お好みで
    # mem_limit: 500m
```

#### `DEBUG_MODE`と`LOW_MEMORY_MODE`
`DEBUG_MODE`はデバッグログを出力するモードです。`LOW_MEMORY_MODE`を有効にすると、httpサーバーがfasthttpでなくnet/httpになります。これはpprofを使用してメモリデバッグを行う際に使用するモードで、実際にメモリ使用量が減ることはほぼありません。パフォーマンスはかなり低下するのでメモリ関係のデバッグ時以外は使わないでください。

##### ！注意！
`DEBUG_MODE`と`LOW_MEMORY_MODE`を両方1にするとデバッグ用のエンドポイント（`/debug`下）が開放されます。これはサーバー上の機密情報を外部に漏洩する可能性があるので絶対に外部からアクセス可能な本番環境で有効にしないでください。

#### 制限
 - 現在開発段階なので、本番環境での利用は推奨されません
 - [Misskeyのメディアプロキシ仕様](https://github.com/misskey-dev/media-proxy/blob/master/SPECIFICATION.md)にはなるべく追従していますが、完全な実装ではありません。以下のような制限があります。
   * staticが指定されていない場合、gif画像とAnimated WebPは無変換でプロキシされます
   * プロキシ対象がapngかつstaticが指定されていない場合、本家と同様そのまま無変換で応答されますが、staticの場合は静止webpに変換されます。
   * フォールバック画像は実装されていません（ToDo）
   * ポート80と443以外へのリクエストはドロップされます
   * 変換クエリが存在しない場合の挙動が本家とは異なります。変換クエリが存在しないかつプロキシ対象のファイルが画像ファイルである場合、webpへのリサイズなしでの変換が行われます。画像ファイルではないかつブラウザセーフなファイル形式の場合そのままプロキシされます。
   * 30MB以上のファイルはプロキシできません
   * （これは本家を使用しているときにも言えることですが）セキュリティ対策は基本的なものを行っていますが完全ではありません。プライベートなネットワークで実行することはあまり推奨されません。

#### topでのメモリ使用量が多い
これはメモリに余裕がある状態だと開放されたヒープが再利用待ちになりOSに返されないということがGoのメモリ管理の特性上あるために発生すると考えられています。
メモリ使用量を減らしたい場合、Dockerやsystemdでメモリ制限をかけることで見かけのメモリ使用量を減らすことができますが、オーバーヘッドやメモリフラグメンテーションの関係上無闇に行うべきではありません。

